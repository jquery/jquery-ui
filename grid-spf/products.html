<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Product Browsing</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<script src="../jquery-1.6.2.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="datasource.js"></script>
	<script src="grid.js"></script>
	<script src="pager.js"></script>
	<script>
	$(function() {
		function parseTimeLeft( value ) {
			return value
			// remove leading character, probably timezone indicator?
			.slice( 1 )
			// insert comma and space
			.replace( /(\d+[A-Z]+)/g, "$1, " )
			// remove at the end
			.replace( /,\s$/, "" )
			// remove entries with 0
			.replace( /(^|\s)0[A-Z]+,?/g, "" )
			// insert words
			.replace( /([A-Z]+)/g, function( match ) {
				return " " + {
					DT: "days",
					H: "hours",
					M: "minutes",
					S: "seconds"
				}[ match ];
			})
			// cut off s for singular entries
			.replace( /(?:^|\s)1 ([a-z]+)s/g, " 1 $1" );
		}

		var ebay = $.ui.datasource({
			paging: {
				limit: 10
			},
			source: function( request, response ) {
				var filter = request.filter;
				var data = {
					"OPERATION-NAME": "findItemsByKeywords",
					"SERVICE-VERSION": "1.0.0",
					"SECURITY-APPNAME": "JrnZaeff-a73f-49ab-8af3-5916011027ef",
					"GLOBAL-ID": "EBAY-US",
					"RESPONSE-DATA-FORMAT": "JSON",
					"keywords": filter.keywords,
					"paginationInput.entriesPerPage": request.paging.limit,
					"sortOrder": request.sort[0],
					// TODO hard limit at 100 pages - pager should be aware of that
					"paginationInput.pageNumber": request.page
				};
				// add item filters
				// http://developer.ebay.com/DevZone/finding/Concepts/FindingAPIGuide.html#useitemfilters
				// http://developer.ebay.com/DevZone/finding/CallRef/types/ItemFilterType.html
				var index = 0,
					arg;
				for ( property in filter ) {
					// keywords is a filter, but has its own field above
					if ( property === "keywords" || $.isEmptyObject( filter[ property ] ) ) {
						continue;
					}
					data[ "itemFilter(" + index + ").name" ] = property;
					for ( arg in filter[ property ] ) {
						data[ "itemFilter(" + index + ")." + arg ] = filter[ property ][ arg ];
					}
					index += 1;
				}
				$.ajax({
					url: "http://svcs.ebay.com/services/search/FindingService/v1",
					dataType: "jsonp",
					data: data,
					success: function( data ) {
						var keywordsResponse = data.findItemsByKeywordsResponse[0];
						var items = keywordsResponse.searchResult[0].item || [];
						response( $.map( items, function( item ) {
							return {
								title: item.title[0],
								condition: item.condition && item.condition[0].conditionDisplayName[0],
								category: item.primaryCategory[0].categoryName[0],
								price: item.sellingStatus[0].currentPrice[0].__value__,
								shipping: item.shippingInfo[0].shippingServiceCost && item.shippingInfo[0].shippingServiceCost[0].__value__,
								timeleft: parseTimeLeft(item.sellingStatus[0].timeLeft[0]),
							}
						}), keywordsResponse.paginationOutput[0].totalEntries[0] );
					}
				});
			}
		});

		var overlay = $( "<div id='loading-overlay'>" )
			.addClass( "ui-widget-overlay" )
			.hide()
			.appendTo( "body" );
		$( ebay ).bind( "datasourcerequest", function() {
			overlay.show();
		}).bind( "datasourceresponse", function() {
			overlay.hide();
		});

		$( "table" ).grid({
			source: ebay
		});

		$( "#pager" ).pager({
			source: ebay
		});

		$( "#sort" ).change(function() {
			ebay.option( "sort", $( this ).val() );
		}).trigger( "change" );

		$( "#keywords" ).change(function() {
			ebay.option( "filter.keywords", $( this ).val() );
		}).trigger( "change" );

		$( "#freeShipping" ).change(function() {
			ebay.option( "filter.FreeShippingOnly", {
				value: $( this ).is( ":checked" )
			});
		}).trigger( "change" );

		$( "#maxPrice" ).change(function() {
			var value = $( this ).val();
			ebay.option( "filter.MaxPrice", value ? {
				value: $( this ).val(),
				paramName: "Currency",
				paramValue: "USD"
			} : {} );
		}).trigger( "change" );

		var listingType = $( "input[name=listingType]" ).change(function() {
			var index = 0,
				values = {};
			listingType.each(function() {
				if ( $( this ).is( ":checked" ) ) {
					values[ "value(" + index + ")" ] = $( this ).val();
					index += 1;
				}
			});
			ebay.option( "filter.ListingType", values ).refresh();
		});

		$( "#sort, #keywords, #freeShipping, #maxPrice" ).change(function() {
			ebay.refresh();
		});
		ebay.refresh();
	});
	</script>
</head>
<body>
	<p>
		Sort:
		<select id="sort" size="4">
			<option value="BestMatch" selected="selected">Best match</option>
			<option value="PricePlusShippingHighest">Price, highest first</option>
			<option value="PricePlusShippingLowest">Price, lowest first</option>
			<option value="EndTimeSoonest">Ends soon</option>
		</select>
	</p>
	<p>
		<label for="keywords">Keywords: </label>
		<input id="keywords" value="harry potter">
	</p>
	<p>
		<input type="checkbox" id="freeShipping">
		<label for="freeShipping">Only Free Shipping</label>
	</p>
	<p>
		<label for="maxPrice">Max Price</label>
		<input id="maxPrice" value="25">
	</p>
	<div>
		Listing Type
		<ul>
			<li>
				<input type="checkbox" id="listing-bin" value="AuctionWithBIN" name="listingType">
				<label for="listing-bin">Auction with BIN</label>
			</li>
			<li>
				<input type="checkbox" id="listing-fixed" value="FixedPrice" name="listingType">
				<label for="listing-fixed">Fixed Price</label>
			</li>
			<li>
				<input type="checkbox" id="listing-store" value="StoreInventory" name="listingType">
				<label for="listing-store">Store Inventory</label>
			</li>
		</ul>
	</div>
	<p id="pager">
		<button data-page="first">First</button>
		<button data-page="prev">Prev</button>
		<button data-page="prevStep">-1</button>
		<span>
			Page <input class="current" size="4"/>/<span class="total">0</span>,
			Total records <span class="totalRecords">0</span>
		</span>
		<button data-page="nextStep">+1</button>
		<button data-page="next">Next</button>
		<button data-page="last">Last</button>
	</p>
	<table>
		<thead>
			<tr>
				<th data-property="title">Title</th>
				<th data-property="condition">Condition</th>
				<th data-property="category">Category</th>
				<th data-property="price">Price ($)</th>
				<th data-property="shipping">Shipping ($)</th>
				<th data-property="timeleft">Time Left</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
</body>
</html>
