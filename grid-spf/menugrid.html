<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Sorting, Paging, Filtering</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<link rel="stylesheet" href="menugrid.css">
	<script src="../jquery-1.6.2.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.menu.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.popup.js"></script>
	<script src="../grid-editing/observable.js"></script>
	<script src="dataview.js"></script>
	<script src="dataview-odata.js"></script>
	<script src="grid.js"></script>
	<script src="pager.js"></script>
	<script src="menugrid.js"></script>
	<script>
	$(function() {
		var movies = $.ui.odataDataview({
			resource: "http://odata.netflix.com/Catalog/Titles",
			request: function() {
				if (this.options.filter) {
					// JSON is far from optimal for URI-encoding, but easy to implement
					location.hash = encodeURIComponent( JSON.stringify( this.options.filter ) );
				} else {
					location.hash = "";
				}
			}
		});

		function checkHash() {
			if (location.hash && location.hash.length > 1) {
				movies.option("filter", JSON.parse( decodeURIComponent( location.hash.substring( 1 ) ) ) ).refresh();
			} else {
				movies.option("filter", null).refresh();
			}
		}
		checkHash();
		$( window ).bind( "hashchange", checkHash );

		$( "#movies" ).menugrid({
			source: movies,
			refresh: function() {
				var paging = movies.options.paging,
					total = movies.totalCount;
				$(".paging-from").text( paging.offset + 1 );
				var to = paging.offset + paging.limit + 1;
				if (to > total) {
					to = total;
				}
				$(".paging-to").text( to );
				$(".paging-total").text( total );
			}
		});

		$("#pagesize").change(function() {
			movies.option("paging.limit", +$(this).val()).refresh();
		});

		$("#refresh").button({
			icons: {
				primary: "ui-icon-refresh"
			}
		}).click(function() {
			movies.refresh();
		})

		$( "#pager" ).pager({
			source: movies
		});

		var overlay = $( "<div id='loading-overlay'>" )
			.addClass( "ui-widget-overlay" )
			.hide()
			.appendTo( "body" );
		$( movies ).bind( "dataviewrequest", function() {
			overlay.show();
		}).bind( "dataviewresponse", function() {
			overlay.hide();
		});

		movies.refresh();
	});
	</script>
	<style>
	#movies {
		width: 800px;
	}
	</style>
</head>
<body>

<h2>Movies! Click headers to sort, use inputs for filtering, pager for paging</h2>
<table id="movies">
	<thead>
		<tr>
			<td colspan="5" class="ui-widget-header">Movies Grid</td>
		</tr>
		<tr>
			<th width="600" data-property="Name" data-type="string">Name</th>
			<th width="100" data-property="ReleaseYear" data-type="number">Release Year</th>
			<th width="100" data-property="AverageRating" data-type="number">Average Rating</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
	<tfoot>
		<tr>
			<td class="ui-state-default">
				<button id="refresh">Refresh</button>
				<span id="pager">
					<button data-page="first">First</button>
					<button data-page="prev">Prev</button>
					<span>
						Page <input class="current" size="4"/> of <span class="total">0</span>
					</span>
					<button data-page="next">Next</button>
					<button data-page="last">Last</button>
				</span>
			</td>
			<td class="ui-state-default">
				<label for="pagesize">Pagesize</label>
				<select id="pagesize">
					<option>10</option>
					<option>20</option>
					<option>30</option>
				</select>
			</td>
			<td class="ui-state-default">
				Viewing rows <span class="paging-from">0</span> to <span class="paging-to">0</span> of <span class="paging-total">0</span>
			</td>
		</tr>
	</tfoot>
</table>

<h3>Some fun results</h3>
<ul>
	<li><a href="#%7B%22AverageRating%22%3A%7B%22operator%22%3A%22%3C%3D%22%2C%22value%22%3A%221.4%22%7D%7D">Bad movies</a></li>
	<li><a href="#%7B%22ReleaseYear%22%3A%7B%22operator%22%3A%22%3D%3D%22%2C%22value%22%3A1997%7D%2C%22AverageRating%22%3A%7B%22operator%22%3A%22%3E%22%2C%22value%22%3A4.1%7D%7D">Party like its 1997</a></li>
	<li><a href="#">Clear filters</a></li>
</ul>

</body>
</html>
