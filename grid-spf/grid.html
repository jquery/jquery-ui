<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Sorting, Paging, Filtering</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<script src="../jquery-1.6.2.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../grid-editing/observable.js"></script>
	<script src="datasource.js"></script>
	<script src="datasource-local.js"></script>
	<script src="datasource-odata.js"></script>
	<script src="grid.js"></script>
	<script src="pager.js"></script>
	<script>
	var localDevelopers;
	$.ajax({
		dataType: "json",
		url: "developers.json",
		async: false,
		success: function( result ) {
			localDevelopers = result;
		}
	});

	$.fn.filterControl = function( datasource ) {
		this.addClass( "tool" ).find( "button" ).click(function() {
			var button = $( this ),
				field = button.data( "filter-field" ),
				value = button.data( "filter-value" ),
				operator = button.data( "filter-operator" ),
				key = "filter." + field;

			if ( datasource.option( "filter." + field ) ) {
				datasource.option( key, null );
			} else {
				datasource.option(key, {
					value: value,
					operator: operator
				});
			}
			datasource.refresh();

			button.toggleClass( "active" );
		})
		return this;
	};

	$.fn.sorterControl = function( datasource ) {
		// TODO see above
		var sorted = {};
		this.addClass( "tool" ).find( "button" ).click(function() {
			var button = $( this ),
				field = button.data( "sort-field" );
			if ( sorted[ field ] ) {
				if ( sorted[ field ].charAt( 0 ) === "-" ) {
					delete sorted[ field ];
					button.removeClass( "active sort-desc" );
				} else {
					sorted[ field ] = "-" + sorted[ field ];
					button.removeClass( "sort-asc" ).addClass( "sort-desc" );
				}
			} else {
				sorted[ field ] = field;
				$( this ).addClass( "active sort-asc" )
			}
			var sort = [];
			for ( var key in sorted ) {
				sort.push( sorted[ key ] );
			}
			datasource.option( "sort", sort ).refresh();
		})
		return this;
	};

	$(function() {
		var developers = $.ui.localDatasource({
			input: localDevelopers,
			paging: {
				limit: 3
			}
		});

		$( "#developers-local" ).grid({
			columns: [ "firstName", "lastName", "country" ],
			source: developers.result,
			select: function( event, ui ) {
				console.log( "Selected " + ui.item.firstName );
			}
		});

		$( "#filterDevelopers" ).filterControl( developers );
		$( "#sortDevelopers" ).sorterControl( developers );
		$( "#pageDevelopers" ).pager({
			source: developers
		});

		developers.refresh();

		// A similar example...but with server integration and remote queries.
		var movies = $.ui.odataDatasource({
			resource: "http://odata.netflix.com/Catalog/Titles"
		});
		$( "#movies" ).grid({
			source: movies.result
		});

		$( "#filterMovies" ).filterControl( movies );
		$( "#sortMovies" ).sorterControl( movies );
		$( "#pageMovies" ).pager({
			source: movies
		});

		movies.refresh();
	});
	</script>
	<style>
	.tool button {
		border: 1px solid white;
	}
	.tool button.active {
		border: 1px solid black;
	}
	.sort-asc:before {
		content: "/\\"
	}
	.sort-desc:before {
		content: "\\/"
	}
	</style>
</head>
<body>

<h1>Grids with local and remote datasource</h1>
<p>features: sorting, filtering, paging</p>

<h2>local data source</h2>
<p id="filterDevelopers">
	Filter:
	<button data-filter-field="firstName" data-filter-value="Scott" type="button">Toggle firstName=Scott</button>
	<button data-filter-field="lastName" data-filter-value="Worth"  type="button">Toggle lastName=Worth</button>
	<button data-filter-field="country" data-filter-value="USA" type="button">Toggle country=USA</button>
	<button data-filter-field="country" data-filter-value="au" data-filter-operator="like" type="button">Toggle country like 'au'</button>
</p>
<p id="sortDevelopers">
	Sort:
	<button data-sort-field="firstName" type="button">Sort by first name</button>
	<button data-sort-field="lastName" type="button">Sort by last name</button>
	<button data-sort-field="country" type="button">Sort country</button>
</p>
<p id="pageDevelopers">
	<button data-page="first">First</button>
	<button data-page="prev">Prev</button>
	<button data-page="prevStep">-1</button>
	<span>
		Page <input class="current" size="4"/>/<span class="total">0</span>,
		Total records <span class="totalRecords">0</span>
	</span>
	<button data-page="nextStep">+1</button>
	<button data-page="next">Next</button>
	<button data-page="last">Last</button>
</p>
<table id="developers-local">
	<thead>
		<tr>
			<th data-property="firstName">First Name</th>
			<th data-property="lastName">Last Name</th>
			<th data-property="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>


<h2>remote data source</h2>
<p id="filterMovies">
	Filter:
	<button data-filter-field="Name" data-filter-operator="like"  data-filter-value="ultra"  type="button">Toggle Name like 'ultra'</button>
	<button data-filter-field="ReleaseYear" data-filter-operator="<="  data-filter-value="1990"  type="button">Toggle ReleaseYear &lt;= 1990</button>
	<button data-filter-field="AverageRating" data-filter-operator=">" data-filter-value="3" type="button">Toggle AverageRating > 3</button>
</p>
<p id="sortMovies">
	Sort:
	<button data-sort-field="Name" type="button">Sort by Name</button>
	<button data-sort-field="ReleaseYear" type="button">Sort by Release Year</button>
	<button data-sort-field="AverageRating" type="button">Sort by Average Rating</button>
</p>
<p id="pageMovies">
	<button data-page="first">First</button>
	<button data-page="prev">Prev</button>
	<button data-page="prevStep">-1</button>
	<span>
		Page <input class="current" size="4"/>/<span class="total">0</span>,
		Total records <span class="totalRecords">0</span>
	</span>
	<button data-page="nextStep">+1</button>
	<button data-page="next">Next</button>
	<button data-page="last">Last</button>
</p>
<table id="movies">
	<thead>
		<tr>
			<th data-property="Name">Name</th>
			<th data-property="ReleaseYear">Release Year</th>
			<th data-property="AverageRating">Average Rating</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

</body>
</html>
