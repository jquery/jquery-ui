<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Photo Slideshow</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<script src="../jquery-1.5.1.js"></script>
	<script src="../external/kite.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="datasource.js"></script>
	<script src="slideshow.js"></script>
	<script src="pager.js"></script>
	<script type="text/x-kite" id="pager-tmpl">
		<div class="controls">
			<button data-page="first">First</button>
			<button data-page="prev">Prev</button>
			<button data-page="prevStep">-1</button>
			<span>
				Page <input class="current" size="4"/>/<span class="total">0</span>,
				Total records <span class="totalRecords">0</span>
			</span>
			<button data-page="nextStep">+1</button>
			<button data-page="next">Next</button>
			<button data-page="last">Last</button>
		</div>
	</script>
	<script type="text/x-kite" id="photo-tmpl">
		<a href="{{href}}" title="{{title}}">
			<img src="{{src}}" width="{{width}}" height="{{height}}" alt="{{alt}}" />
		</a>
	</script>
	<script>
	$(function() {
		// TODO must be possible to set these through the datasource
		$.ajaxSetup({
			dataType: "jsonp",
			jsonpCallback: "jsonFlickrApi",
		});
		var flickr = $.dataSource({
			path: "http://api.flickr.com/services/rest/",
			urlMapper: function(path, queryParams, sort, filter, skip, take) {
				return path + "?" + $.param({
					format: "json",
					api_key: "d86848d57cb3f7ad94f2ee9a3c90eff1",
					method: "flickr.photos.search",
					tags: filter[0].filterValue,
					sort: "relevance",
					per_page: take,
					page: Math.ceil((skip || 0) / take + 1)
				});
			},
			resultsFilter: function (data) {
		        this.totalCount = data.photos.total;
		        return $.map( data.photos.photo, function( photo ) {
					return {
						src: kite( "http://farm{{farm}}.static.flickr.com/{{server}}/{{id}}_{{secret}}_m.jpg", photo ),
						href: kite( "http://www.flickr.com/photos/{{owner}}/{{id}}/", photo )
					}
				});
		    }
		});
		
		// wrap the original source to preload
		datasource = $.dataSource({
			path: "doesn't-matter-just-need-a-remote-source",
			paging: { take: 2 }
		});
		// TODO needs to load next batch before reaching the last local page
		datasource._refresh = function(options, completed) {
			flickr._take = datasource._take * 3;
			flickr._filter = this._filter;
			
			// TODO this breaks down when not just using next page
			if (this._nextTake && this._nextTake.length) {
				this._items = this._nextTake.slice(0, datasource._take);
				this._nextTake = this._nextTake.slice(datasource._take);
				completed();
				return;
			}
			
			flickr._skip = this._skip;
			// TODO would be nice to be able to just pass this as a callback to refresh
			flickr.option("refresh", function() {
				datasource._items = flickr._items.slice(0, datasource._take);
				datasource._nextTake = flickr._items.slice(datasource._take);
				datasource.totalCount = flickr.totalCount;
				completed();
			}).refresh();
		};

		$( "#slideshow" ).slideshow({
			source: datasource
		});
		
		$( kite( "#pager-tmpl" )() ).insertBefore( "#slideshow" ).pager({
			source: datasource
		});

		$( "#page-size" ).change(function() {
			datasource.option("paging", {
				take: +$(this).val(),
				// can't yet only set take
				skip: datasource._skip
			}).refresh();
		});
		
		$( "#filter" ).change(function() {
			datasource.option("filter", {
				property: "tags",
				value: $(this).val()
			}).refresh();
		}).trigger("change");
	});
	
	</script>
</head>
<body>

<h1>Photo Slideshow</h1>
<p>features: paging</p>

<hr>

<p>
	Per page: <input id="page-size" value="2">
</p>
<p>
	Tags to look for (comma seperated): <input id="filter" value="jquery"> 
</p>


<div id="slideshow"></div>

</body>
</html>
