<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Editing, Inline Grid</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="../grid-spf/grid.css">
	<script src="../jquery-1.6.2.js"></script>
	<script src="../external/globalize.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../external/jquery.mousewheel-3.0.4.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.spinner.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.tooltip.js"></script>
	<script src="../ui/jquery.ui.autocomplete.js"></script>
	<script src="../ui/jquery.ui.menu.js"></script>
	<script src="../grid-spf/datasource.js"></script>
	<script src="../grid-spf/datasource-local.js"></script>
	<script src="../grid-spf/grid.js"></script>
	<script src="../grid-spf/pager.js"></script>
	<script src="observable.js"></script>
	<script src="editor.js"></script>
	<script src="grid-editor.js"></script>
	<script src="editor-countrycomplete.js"></script>
	<script src="editor-randomspinner.js"></script>
	<script src="navigator.js"></script>
	<script src="localstore.js"></script>
	<script src="helpers.js"></script>
	<script>
	if ( !window.console ) {
		window.console = {
			log: function() {
				var message = Array.prototype.slice.call( arguments, 1 ).join( ", " );
				$("<div>").text( message ).appendTo("body");
			}
		}
	}

	var store = $.demos.localstore( {
		key: "grid-editing-developers",
		initial: "../grid-spf/developers.json"
	});
	var localDevelopers = store.load();

	$(function() {
		var developers = $.ui.localDatasource({
			input: localDevelopers,
			paging: {
				limit: 8
			}
		});
		developers.save = function() {
			store.save( localDevelopers );
			return this;
		}
		// TODO $.observable should support this binding, along with a less intrusive event facility
		function bindChange(index, developer) {
			$.observable( developer ).bind("change", function(event, ui) {
				developers.refresh().save();
			});
		}
		$.observable( localDevelopers ).bind("insert remove", function(event, ui) {
			if ( event.type === "insert" ) {
				$.each( ui.items, bindChange );
			}
			developers.refresh().save();
		})
		$.each( localDevelopers, bindChange );

		var grid = $( "#developers-local" ).grid({
			source: developers
		});

		grid.gridEditor({
			items: "td:not(:has(button))",
			done: function() {
				// for the navigator
				grid.focus();
			}
		});
		grid.navigator();

		var developer;
		var editForm = $( "#editForm" ).tooltip().hide().submit( function( event ) {
			event.preventDefault();
			$.observable(developer).property( serializeForm( this ) );
			editForm.hide();
		});
		grid.delegate( "button.edit", "click", function() {
			developer = $( this ).closest("tr").data( "grid-item" );
			$( "#edit-tmpl" ).tmpl( meta(developer) ).appendTo( editForm.find("fieldset").empty() );
			editForm.show().find("input:first").focus();
		});
		grid.delegate( "button.remove", "click", function() {
			var developer = $( this ).closest("tr").data( "grid-item" );
			$.observable( localDevelopers ).remove( developer );
		});

		$( "#pageDevelopers" ).pager({
			source: developers
		});

		function newDeveloper() {
			return {
				firstName: [ "Peter", "Unknown", "Carl" ][ Math.floor( Math.random() * 3 ) ],
				lastName: [ "Pan", "Unkown", "Worth" ][ Math.floor( Math.random() * 3 ) ],
				country: [ "Unknown", "Pandistan", "Petertan" ][ Math.floor( Math.random() * 3 ) ],
				bitcoins: Math.floor( Math.random() * 1500 ),
				random: {
					value: Math.floor( Math.random() * 13 )
				},
				date: +new Date()
			}
		}
		$( "#addDeveloper" ).click( function() {
			$.observable( localDevelopers ).insert( 0, newDeveloper() );
		});
		$( "#addDeveloperAtEnd" ).click( function() {
			$.observable( localDevelopers ).insert( newDeveloper() );
		});

		developers.refresh();
	});
	</script>
	<style>
		.navigator-active { background: rgba(0,0,255,0.1); }
		.ui-autocomplete { width: 200px; max-height: 200px; overflow: auto; }
		#developers-local {
			width: 700px;
		}
		thead td { text-align: center; }
		#pageDevelopers { text-align: center; }
		.totals { padding-left: 1em; }

		/* TODO make this actually work */
		tbody { min-height: 264px; }
	</style>
</head>
<body>

<h1>Grids with editable local datasource</h1>

<h2>local data source</h2>
<p>See also <a href="grid-selectable.html">grid-selectable</a></p>
<table id="developers-local">
	<thead>
		<tr>
			<td colspan="9" class="ui-widget-header">Developers Grid</td>
		</tr>
		<tr>
			<th width="70" data-property="firstName">First Name</th>
			<th width="70" data-property="lastName">Last Name</th>
			<th width="70" data-property="country" data-editor="countrycomplete">Country</th>
			<th width="60" data-property="bitcoins" data-type="number" data-editor="spinner">Bitcoins</th>
			<th width="70" data-template="#cell-date-tmpl">Date</th>
			<th width="80" data-template="#cell-time-tmpl">Time</th>
			<th width="60" data-property="random.value" data-type="number" data-editor="randomSpinner" data-editor-options='{"min":-1, "max": 125}'>Random</th>
			<th width="40" data-template="#cell-edit-tmpl">Edit</th>
			<th width="60" data-template="#cell-remove-tmpl">Remove</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
	<tfoot>
		<tr>
			<td id="pageDevelopers" colspan="9" class="ui-state-default">
				<button data-page="first">First</button>
				<button data-page="prev">Prev</button>
				<span>
					Page <input class="current" size="4"/> of <span class="total">0</span>
				</span>
				<button data-page="next">Next</button>
				<button data-page="last">Last</button>
				<span class="totals">
					Total records <span class="totalRecords">0</span>
				</span>
			</td>
		</tr>
	</tfoot>
</table>

<div>
	<button id="addDeveloper">Insert new developer</button>
	<button id="addDeveloperAtEnd">Insert new developer at the end</button>
</div>
<form id="editForm">
	<fieldset>
	</fieldset>
	<input type="submit" value="Save changes" />
</form>
<script id="edit-tmpl" type="text/x-jquery-tmpl">
{{if $.isArray(value)}}
	<ul>
		{{each(index, valueX) value}}
			<li><input type="text" name="${name}" placeholder="${label}" value="${valueX}" title="${label}" /></li>
		{{/each}}
	</ul>
{{else}}
	<input type="text" name="${name}" placeholder="${label}" value="${value}" title="${label}" />
{{/if}}
</script>
<script id="cell-date-tmpl" type="text/x-jquery-tmpl">
	<td class="ui-widget-content">${Globalize.format(new Date(date), "d")}</td>
</script>
<script id="cell-time-tmpl" type="text/x-jquery-tmpl">
	<td class="ui-widget-content">${Globalize.format(new Date(date), "T")}</td>
</script>
<script id="cell-edit-tmpl" type="text/x-jquery-tmpl">
	<td class="ui-widget-content"><button class='edit'>Edit</button></td>
</script>
<script id="cell-remove-tmpl" type="text/x-jquery-tmpl">
	<td class="ui-widget-content"><button class='remove'>Remove</button></td>
</script>

</body>
</html>
